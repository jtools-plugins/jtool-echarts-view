<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <title>ECharts 可视化</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/json5/2.2.3/index.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f4f6fa;
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
        }

        .header {
            background: #23272f;
            color: #fff;
            padding: 18px 32px;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            margin: 10px;
            width: 90%;
            gap: 32px;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            padding: 24px;
            flex: 1 1 0;
            min-width: 0;
            width: 93%;
            display: flex;
            flex-direction: column;
        }

        .option-title {
            font-size: 1.1rem;
            color: #1976d2;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .option-json {
            background: #23272f;
            color: #e3eaf2;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
            font-size: 14px;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            min-height: 320px;
            max-height: 480px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .chart-title {
            font-size: 1.1rem;
            color: #1976d2;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #main {
            width: 100%;
            min-height: 320px;
            height: 400px;
            border-radius: 8px;
            background: #f9fafb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .error {
            margin: 24px auto 0 auto;
            max-width: 1100px;
            color: #fff;
            background: #e53935;
            border-radius: 8px;
            font-size: 15px;
            padding: 12px 24px;
            box-shadow: 0 2px 8px rgba(229, 57, 53, 0.08);
            min-height: 24px;
            letter-spacing: 1px;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                gap: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="header">ECharts 可视化</div>
    <div class="container">
        <div class="card">
            <div class="chart-title">图表展示</div>
            <div id="main"></div>
        </div>
        <div class="card">
            <div class="option-title">Option JSON</div>
            <pre id="debug" class="option-json">等待可视化...</pre>
        </div>

    </div>
    <div id="error" class="error"></div>

    <script>
        document.getElementById('main').style.height = '400px';
        document.getElementById('main').style.width = '100%';
        let chart = echarts.init(document.getElementById('main'));
        if (!chart) {
            document.getElementById('error').innerText = 'ECharts 初始化失败';
        } else {
            document.getElementById('error').innerText = '';
        }

        // 页面加载后不自动渲染，等待 renderECharts 调用
        function isArray(val) {
            return Array.isArray(val);
        }

        function mockArray(len, type) {
            if (type === 'category') {
                return ['A', 'B', 'C', 'D', 'E'].slice(0, len || 5);
            } else {
                return [10, 20, 30, 40, 50].slice(0, len || 5);
            }
        }

        function replaceDataFields(optionStr, mockArrStr) {
            let result = '';
            let i = 0;
            while (i < optionStr.length) {
                let dataIdx = optionStr.indexOf('data', i);
                if (dataIdx === -1) {
                    result += optionStr.slice(i);
                    break;
                }
                // 检查是不是 data:（防止变量名、字符串等误伤）
                let colonIdx = optionStr.indexOf(':', dataIdx);
                if (colonIdx === -1) break;
                // 追加前面的内容
                result += optionStr.slice(i, colonIdx + 1);
                // 跳过空格
                let j = colonIdx + 1;
                while (optionStr[j] === ' ' || optionStr[j] === '\n' || optionStr[j] === '\r') j++;
                // 找下一个 , 或 }
                let endIdx = j;
                let inBracket = 0, inQuote = false;
                while (endIdx < optionStr.length) {
                    let ch = optionStr[endIdx];
                    if (ch === '"' || ch === "'") inQuote = !inQuote;
                    if (!inQuote) {
                        if (ch === '[') inBracket++;
                        if (ch === ']') inBracket--;
                        if (inBracket === 0 && (ch === ',' || ch === '}')) break;
                    }
                    endIdx++;
                }
                // 替换为 mock
                result += ' ' + mockArrStr;
                // 跳到 , 或 }
                i = endIdx;
            }
            return result;
        }

        function renderECharts(option) {
            let debugDiv = document.getElementById('debug');
            let optionObj = option;
            let parseError = null;
            let debugInfo = '';
            try {
                if (typeof option === 'string') {
                    debugInfo += '原始字符串:\n' + option + '\n\n';
                    try {
                        // 1. 先尝试 JSON5 解析
                        optionObj = JSON5.parse(option);
                        debugInfo += 'JSON5 解析成功\n';
                    } catch (e) {
                        debugInfo += 'JSON5 解析失败: ' + e.message + '\n';
                        // 2. 一刀切 mock 替换所有 data: xxx
                        let replaced = option.replace(/data\s*:\s*([a-zA-Z_][a-zA-Z0-9_]*)\b(?!\s*[\[\{\\"'])/g, 'data: [10, 20, 30, 40, 50]');
                        debugInfo += 'mock 替换后:\n' + replaced + '\n\n';
                        try {
                            optionObj = JSON5.parse(replaced);
                            debugInfo += 'mock 替换后 JSON5 解析成功\n';
                        } catch (e2) {
                            debugInfo += 'mock 替换后 JSON5 解析失败: ' + e2.message + '\n';
                            parseError = e2;
                            optionObj = null;
                        }
                    }
                }
                if (optionObj) {
                    debugInfo += '最终 optionObj:\n' + JSON.stringify(optionObj, null, 2);
                    debugDiv.innerText = debugInfo;
                } else {
                    throw parseError || new Error('option无法解析');
                }
            } catch (e) {
                debugDiv.innerText = debugInfo + '\noption解析异常: ' + e.message + '\n请用标准 JSON 格式（所有 key、字符串用双引号，不能有变量/注释）';
                document.getElementById('error').innerText = 'option解析异常: ' + e.message;
                return;
            }
            document.getElementById('error').innerText = '';
            try {
                // mock xAxis.data
                if (optionObj.xAxis) {
                    let xArr = Array.isArray(optionObj.xAxis) ? optionObj.xAxis : [optionObj.xAxis];
                    xArr.forEach(function (x) {
                        if (!Array.isArray(x.data)) {
                            x.data = ["A", "B", "C", "D", "E"];
                        }
                    });
                }
                // mock yAxis.data（极少用，但也兼容）
                if (optionObj.yAxis) {
                    let yArr = Array.isArray(optionObj.yAxis) ? optionObj.yAxis : [optionObj.yAxis];
                    yArr.forEach(function (y) {
                        if (y && !Array.isArray(y.data)) {
                            y.data = [10, 20, 30, 40, 50];
                        }
                    });
                }
                // mock series.data
                if (optionObj.series && Array.isArray(optionObj.series)) {
                    optionObj.series.forEach(function (s) {
                        if (!Array.isArray(s.data)) {
                            if (s.type === 'line' || s.type === 'bar') {
                                s.data = [10, 20, 30, 40, 50];
                            } else if (s.type === 'pie') {
                                s.data = [
                                    { name: 'A', value: 10 },
                                    { name: 'B', value: 20 },
                                    { name: 'C', value: 30 }
                                ];
                            } else if (s.type === 'scatter') {
                                s.data = [[10, 20], [20, 30], [30, 40]];
                            }
                        }
                    });
                    // xAxis/yAxis 补全
                    let first = optionObj.series[0];
                    if ((first.type === 'line' || first.type === 'bar' || first.type === 'scatter')) {
                        if (!optionObj.xAxis) {
                            optionObj.xAxis = { type: 'category', data: ["A", "B", "C", "D", "E"] };
                        }
                        if (!optionObj.yAxis) {
                            optionObj.yAxis = {};
                        }
                    }
                }
                chart.clear();
                chart.setOption(optionObj, true);
            } catch (e) {
                chart.clear();
                document.getElementById('error').innerText = '渲染失败: ' + e.message + '\n' + e.stack;
            }
        }

        window.renderECharts = renderECharts;
    </script>
</body>

</html>